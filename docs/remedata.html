<!DOCTYPE html>

<html>
<head>
  <title>remedata.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="app.html">
                  app.js
                </a>
              
                
                <a class="source" href="jsondb.html">
                  jsondb.js
                </a>
              
                
                <a class="source" href="remedata.html">
                  remedata.js
                </a>
              
                
                <a class="source" href="wsapp.html">
                  wsapp.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>remedata.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h4 id="remedata-js-easy-express-middle-ware-to-provide-json-web-services-with-mock-data-access">Remedata.js - easy Express middle-ware to provide json web-services with mock data-access</h4>
<h5 id="v-1-0-0-documentation-generated-with-the-lovely-docco-http-jashkenas-github-com-docco-">v 1.0.0 - Documentation generated with the lovely <a href="http://jashkenas.github.com/docco/">Docco</a></h5>
<blockquote>
<p>Copyright (c) 2012-2015 Iwan van der Kleijn
All rights reserved.</p>
<p>This source code is licensed under the BSD-style license found in the LICENSE file in the root directory of this source tree. An additional grant of patent rights can be found in the PATENTS file in the same directory.</p>
</blockquote>
<p>Be aware that Remedata is written in ECMAScript 6 (2015). If executed in an ECMAScript 5 compatible run-time, youÂ´ll need
<a href="http://babeljs.org">Babel</a> to compile, or transpile, the source files (in src) to their transformed destinations (in dist)
For an excellent overview of ES6 see: <a href="https://babeljs.io/docs/learn-es6/">https://babeljs.io/docs/learn-es6/</a></p>
<h5 id="other-files-included-in-remedata">Other files included in Remedata</h5>
<p>Json DB mock <a href="jsondb.html">jsondb.html</a>
Example: <a href="app.html">app.html</a></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h5 id="begin-remedata-js-source">Begin remedata.js source</h5>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Import standard ES6 API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> corejs <span class="hljs-keyword">from</span> <span class="hljs-string">'core-js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Publish public interface of jsondb as part of remedata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> * from <span class="hljs-string">'./jsondb'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Represents HTTP return codes (i.e. 200 OK, 404 Not Found etc)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Status</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>ES6 class constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor(code, message, data){
    <span class="hljs-keyword">this</span>.code = code;
    <span class="hljs-keyword">this</span>.message = message;
    <span class="hljs-keyword">this</span>.data = data || <span class="hljs-literal">null</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>ES6 Property Read syntax</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get Code (){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.code;
  }
  
  get Message() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.message;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Auxiliary payload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get Data() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data;
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Known HTTP Status codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Status.OK = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Status(<span class="hljs-number">200</span>, <span class="hljs-string">"OK"</span>, data);
};

Status.NOTFOUND = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Status(<span class="hljs-number">404</span>, <span class="hljs-string">"Not found"</span>, data);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Generic HTTP error code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Status.ERROR = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(message, data)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Status(<span class="hljs-number">500</span>, message, data);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Utility function to encapsulate server response or, if given a handler,
delegate the response to the handler function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> response = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data, req, res, callback)</span></span>{
  
  <span class="hljs-keyword">if</span> (callback){
    callback(err, data, req, res);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(err){
      res.status(<span class="hljs-number">500</span>).send(err.message);
    } <span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">if</span>(data <span class="hljs-keyword">instanceof</span> Status){</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Send an HTTP statuscode  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.status(data.Code).send(data.Message);
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>or the data as JSON payload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.json(data);
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>get Url metadata; 
{request object} -&gt; {url meta-data } </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> urlInfo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req)</span></span>{
  <span class="hljs-keyword">let</span> isAll = req.url.endsWith(<span class="hljs-string">'/'</span>);
  <span class="hljs-keyword">let</span> parts = req.url.split(<span class="hljs-string">'/'</span>);
  <span class="hljs-keyword">let</span> id = parts[parts.length-<span class="hljs-number">1</span>];
  <span class="hljs-keyword">return</span> {isAll, parts, id};
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Returns Express handler for GET requests
jsondb instance [] -&gt; ()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> handleGET = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, callback)</span></span>{

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span></span>{
 
    <span class="hljs-keyword">let</span> {isAll, parts, id} = urlInfo(req);
   
    <span class="hljs-keyword">if</span>(isAll) {
      db.getAll((err, data)=&gt;{

        response(err, data, req, res, callback);
      });
    } <span class="hljs-keyword">else</span> {
      db.getBy(id,(err, data)=&gt;{
        <span class="hljs-keyword">if</span>(!data){

          response(err, Status.NOTFOUND(id), req, res, callback);
        }<span class="hljs-keyword">else</span>{

          response(err, data, req, res, callback);
        }
      });
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Returns Express handler for PUT requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> handlePUT = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, callback)</span></span>{

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span></span>{

    <span class="hljs-keyword">let</span> {isAll, parts, id} = urlInfo(req);
    <span class="hljs-keyword">let</span> data = req.body;

    <span class="hljs-keyword">if</span> (callback) {
      <span class="hljs-keyword">let</span> data = callback({id, data, url: req.url, isCollection: isAll}, req, res);
      <span class="hljs-keyword">if</span> (isNone(data)){
        response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No data returned from Handle'</span>), <span class="hljs-literal">null</span>, req, res);
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-keyword">if</span>(isAll) {
      response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot PUT to collection without id"</span>), <span class="hljs-literal">null</span>, req, res, callback);
    } <span class="hljs-keyword">else</span> {
      
      <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>){
        response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot PUT an array to collection"</span>), <span class="hljs-literal">null</span>, req, res, callback);
        <span class="hljs-keyword">return</span>;
      }

      data[db.Id] = id;
      db.save(data,(err)=&gt;{
        response(err, Status.OK(data), req, res, callback);
      });
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Returns Express handler for DELETE requests
JsonDb [callback] -&gt; void</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> handleDELETE = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, callback)</span></span>{

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span></span>{

    <span class="hljs-keyword">let</span> {isAll, parts, id} = urlInfo(req);

    <span class="hljs-keyword">if</span> (callback) {
      <span class="hljs-keyword">let</span> id = callback({id, data, url: req.url, isCollection: isAll}, req, res);
      <span class="hljs-keyword">if</span> (isNone(id)){
        response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No id returned from Handle'</span>), <span class="hljs-literal">null</span>, req, res);
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-keyword">if</span>(isAll) {
      response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot DELETE from an collection without id"</span>), <span class="hljs-literal">null</span>, req, res, callback);
    } <span class="hljs-keyword">else</span> {
      
      db.deleteBy(id,(err, deleted)=&gt;{

        <span class="hljs-keyword">if</span> (deleted){
          response(err, Status.OK(id), req, res, callback);
        } <span class="hljs-keyword">else</span> {
          response(err, Status.NOTFOUND(id), req, res, callback);
        }
      });
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Returns Express handler for POST requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> handlePOST = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, preprocess, callback)</span></span>{

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span></span>{

    <span class="hljs-keyword">let</span> {isAll, parts, id} = urlInfo(req);
    <span class="hljs-keyword">let</span> data = req.body;

    <span class="hljs-keyword">if</span> (callback) {
      <span class="hljs-keyword">let</span> data = callback({id, data, url: req.url, isCollection: isAll}, req, res);
      <span class="hljs-keyword">if</span> (isNone(data)){
        response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No data returned from Handle'</span>), <span class="hljs-literal">null</span>, req, res);
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-keyword">if</span>(isAll) {
      <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>){
        db.saveAll(data, (err)=&gt; {
          response(err, Status.OK({data, id, url: req.url, isCollection: isAll}), req, res, callback);
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!(data[db.Id])){
          response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`No key '<span class="hljs-subst">${db.Id}</span>' set on data-item`</span>), <span class="hljs-literal">null</span>, req, res, callback);
        } <span class="hljs-keyword">else</span> {
          db.save(data, (err)=&gt; {
            response(err, Status.OK({data, id, url: req.url, isCollection: isAll}), req, res, callback);
          });
        }
      }
    } <span class="hljs-keyword">else</span> {
      response(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot POST to single item"</span>), <span class="hljs-literal">null</span>, req, res, callback);
    }
  };
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
